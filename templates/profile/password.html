{% extends "base.html" %}

{% block title %}Change Password - {{ app_name }}{% endblock %}

{% set active_page = 'profile' %}
{% block nav_items %}
{% if user.role_name == 'Admin' %}
{% include 'components/nav_admin.html' %}
{% else %}
{% include 'components/nav_student.html' %}
{% endif %}
{% endblock %}
{% block mobile_nav %}
{% if user.role_name == 'Admin' %}
{% include 'components/nav_admin_mobile.html' %}
{% else %}
{% include 'components/nav_student_mobile.html' %}
{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
    <a href="{{ url_for('profile.view_profile') }}" class="back-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back to Profile
    </a>
    <h1 class="page-title">Change Password</h1>
    <p class="page-subtitle">Update your account password</p>
</div>

<div class="password-card">
    <form id="passwordForm">
        <div class="form-group">
            <label class="form-label">Current Password</label>
            <input type="password" name="current_password" class="form-input" required autocomplete="current-password">
        </div>
        <div class="form-group">
            <label class="form-label">New Password</label>
            <input type="password" name="new_password" class="form-input" required minlength="6" autocomplete="new-password">
            <span class="form-hint">Minimum 6 characters</span>
        </div>
        <div class="form-group">
            <label class="form-label">Confirm New Password</label>
            <input type="password" name="confirm_password" class="form-input" required autocomplete="new-password">
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-primary" id="saveBtn">Change Password</button>
            <a href="{{ url_for('profile.view_profile') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<style>
.back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--azure-blue);
    text-decoration: none;
    font-size: 0.875rem;
    margin-bottom: 1rem;
}
.back-link:hover {
    text-decoration: underline;
}
.back-link svg {
    width: 16px;
    height: 16px;
}
.password-card {
    background: var(--neutral-white);
    border: 1px solid var(--neutral-gray-6);
    border-radius: var(--radius-large);
    padding: 1.5rem;
    max-width: 400px;
}
.btn-group {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
}
</style>

<script>
document.getElementById('passwordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById('saveBtn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Saving...';

    const formData = new FormData(this);
    const data = {
        current_password: formData.get('current_password'),
        new_password: formData.get('new_password'),
        confirm_password: formData.get('confirm_password')
    };

    try {
        const response = await fetch('{{ url_for("profile.change_password") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();

        if (result.success) {
            showAlert(result.message, 'success');
            this.reset();
        } else {
            showAlert(result.error || 'Failed to change password', 'error');
        }
    } catch (error) {
        showAlert('Connection error', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
});
</script>
{% endblock %}
